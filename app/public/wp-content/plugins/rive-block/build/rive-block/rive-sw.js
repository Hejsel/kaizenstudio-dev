const CACHE_VERSION="rive-block-v2",CACHE_NAME=`${CACHE_VERSION}-assets`,OPFS_DIRECTORY="rive-wasm-cache",STATIC_ASSETS=["/wp-content/plugins/rive-block/build/rive-block/webgl2_advanced.wasm","/wp-content/plugins/rive-block/build/rive-block/view.js"];async function getOPFSDirectory(){const e=await navigator.storage.getDirectory();return await e.getDirectoryHandle(OPFS_DIRECTORY,{create:!0})}async function saveToOPFS(e,t){try{const a=await getOPFSDirectory(),n=await a.getFileHandle(e,{create:!0}),o=await n.createWritable();await t.body.pipeTo(o),console.log("[Rive SW OPFS] Saved to OPFS:",e)}catch(t){throw console.error("[Rive SW OPFS] Failed to save:",e,t),t}}async function loadFromOPFS(e){try{const t=await getOPFSDirectory(),a=await t.getFileHandle(e,{create:!1}),n=await a.getFile();return console.log("[Rive SW OPFS] Loaded from OPFS:",e,`(${n.size} bytes)`),new Response(n,{status:200,headers:{"Content-Type":"application/wasm","Content-Length":n.size,"X-Rive-Source":"opfs"}})}catch(t){return console.log("[Rive SW OPFS] Not found in OPFS:",e),null}}async function existsInOPFS(e){try{const t=await getOPFSDirectory();return await t.getFileHandle(e,{create:!1}),!0}catch{return!1}}async function handleWASMRequest(e,t){const a=t.pathname.split("/").pop(),n=await loadFromOPFS(a);if(n)return n;console.log("[Rive SW] Fetching WASM from network:",a);try{const t=await fetch(e);return t&&200===t.status?(saveToOPFS(a,t.clone()).catch(e=>{console.error("[Rive SW] Failed to save WASM to OPFS:",e)}),t):t}catch(e){throw console.error("[Rive SW] WASM fetch failed:",a,e),e}}async function handleCacheRequest(e,t){const a=await caches.match(e);if(a)return console.log("[Rive SW] Serving from cache:",t.pathname),a;console.log("[Rive SW] Fetching from network:",t.pathname);try{const a=await fetch(e);if(!a||200!==a.status)return a;const n=a.clone(),o=await caches.open(CACHE_NAME);return await o.put(e,n),console.log("[Rive SW] Cached:",t.pathname),a}catch(e){throw console.error("[Rive SW] Fetch failed:",t.pathname,e),e}}self.addEventListener("install",e=>{console.log("[Rive SW] Installing Service Worker vrive-block-v2"),e.waitUntil(caches.open(CACHE_NAME).then(e=>(console.log("[Rive SW] Caching static assets"),e.addAll(STATIC_ASSETS))).then(()=>(console.log("[Rive SW] Static assets cached successfully"),self.skipWaiting())).catch(e=>{console.error("[Rive SW] Installation failed:",e)}))}),self.addEventListener("activate",e=>{console.log("[Rive SW] Activating Service Worker vrive-block-v2"),e.waitUntil(caches.keys().then(e=>Promise.all(e.filter(e=>e.startsWith("rive-block-")&&e!==CACHE_NAME).map(e=>(console.log("[Rive SW] Deleting old cache:",e),caches.delete(e))))).then(()=>(console.log("[Rive SW] Old caches cleaned up"),self.clients.claim())))}),self.addEventListener("fetch",e=>{const{request:t}=e,a=new URL(t.url),n=a.pathname.includes("/rive-block/")&&a.pathname.endsWith(".wasm"),o=a.pathname.includes("/rive-block/")&&(a.pathname.endsWith(".riv")||a.pathname.includes("/view.js"));(n||o)&&(n?e.respondWith(handleWASMRequest(t,a)):e.respondWith(handleCacheRequest(t,a)))}),self.addEventListener("message",e=>{e.data&&"SKIP_WAITING"===e.data.type&&(console.log("[Rive SW] Received SKIP_WAITING message"),self.skipWaiting()),e.data&&"CLEAR_CACHE"===e.data.type&&(console.log("[Rive SW] Clearing cache"),e.waitUntil(caches.delete(CACHE_NAME).then(()=>(console.log("[Rive SW] Cache cleared"),self.clients.matchAll())).then(e=>{e.forEach(e=>{e.postMessage({type:"CACHE_CLEARED"})})})))});